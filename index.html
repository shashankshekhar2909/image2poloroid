<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Polaroid A4 Sheet (Caption Rotated)</title>

  <!-- HEIC to JPEG converter -->
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <style>
    :root {
      --page-width: 210mm;
      --page-height: 297mm;
      --page-pad: 5mm;
      --gap: 4mm;
      --polaroid-width: 80mm;
      --polaroid-height: 65mm;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f0f0f0;
    }

    h1 { margin: 0 0 4px 0; font-size: 18px; }

    .controls {
      max-width: 900px;
      margin: 0 auto 16px auto;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .controls-left { max-width: 65%; }

    .sub { font-size: 12px; color: #555; }
    .warning { font-size: 11px; color: #b65a00; }

    label { font-size: 13px; font-weight: 500; }

    .pages-wrapper {
      max-width: var(--page-width);
      margin: 0 auto 24px auto;
    }

    .page {
      width: var(--page-width);
      height: var(--page-height);
      margin: 16px auto;
      background: #ffffff;
      box-shadow: 0 3px 10px rgba(0,0,0,0.18);
      padding: var(--page-pad);
      display: grid;
      grid-template-columns: repeat(2, var(--polaroid-width));
      grid-template-rows: repeat(4, var(--polaroid-height));
      justify-content: center;
      gap: var(--gap);
    }

    .polaroid {
      width: 100%;
      height: 100%;
      display: flex;
      background: #ffffff;
      border-radius: 1.5mm;
      padding: 3mm 3mm 6mm 3mm;
      flex-direction: column;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .polaroid-image-wrapper {
      flex: 1;
      border-radius: 1mm;
      background: #e0e0e0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .polaroid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* rotate caption only */
    .polaroid-caption {
      margin-top: 3mm;
      height: 8mm;
      font-size: 9px;
      text-align: center;
      color: #777;
      font-style: italic;

      transform: rotate(90deg);
      transform-origin: left top;
      white-space: nowrap;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media print {
      @page { size: A4 portrait; margin: 0; }
      body { margin: 0; padding: 0; background: #ffffff; }
      .controls { display: none !important; }
      .page { margin: 0; box-shadow: none; page-break-after: always; }
    }
  </style>
</head>

<body>
  <div class="controls">
    <div class="controls-left">
      <h1>Polaroid A4 Sheet Generator</h1>
      <div class="sub">
        Images stay normal. Only caption rotated 90Â° and aligned at the bottom.
      </div>
      <div class="warning">
        HEIC images are converted to JPEG automatically.
      </div>
    </div>
    <div>
      <label for="fileInput">Choose photos:</label>
      <input id="fileInput" type="file" accept="image/*,.heic,.heif" multiple />
    </div>
  </div>

  <div class="pages-wrapper" id="pagesWrapper">
    <p class="no-images" id="noImagesText">
      No images loaded yet. Use the "Choose photos" button above.
    </p>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const pagesWrapper = document.getElementById('pagesWrapper');
    const noImagesText = document.getElementById('noImagesText');

    fileInput.addEventListener('change', handleFiles);

    async function handleFiles(event) {
      const files = Array.from(event.target.files || []);
      pagesWrapper.innerHTML = '';

      if (!files.length) {
        noImagesText.style.display = 'block';
        pagesWrapper.appendChild(noImagesText);
        return;
      }

      noImagesText.style.display = 'none';

      const perPage = 8;
      let currentPage = null;
      let countOnPage = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        if (countOnPage === 0) {
          currentPage = document.createElement('div');
          currentPage.className = 'page';
          pagesWrapper.appendChild(currentPage);
        }

        const polaroid = await createPolaroidElement(file, i);
        currentPage.appendChild(polaroid);

        countOnPage++;
        if (countOnPage === perPage) countOnPage = 0;
      }
    }

    async function createPolaroidElement(file, index) {
      const polaroid = document.createElement('div');
      polaroid.className = 'polaroid';

      const imgWrapper = document.createElement('div');
      imgWrapper.className = 'polaroid-image-wrapper';

      const img = document.createElement('img');

      const caption = document.createElement('div');
      caption.className = 'polaroid-caption';
      caption.textContent = (file.name || `Photo ${index + 1}`).replace(/\.[^/.]+$/, '');

      const dataUrl = await loadImage(file);
      if (dataUrl) img.src = dataUrl;

      imgWrapper.appendChild(img);
      polaroid.appendChild(imgWrapper);
      polaroid.appendChild(caption);

      return polaroid;
    }

    async function loadImage(file) {
      const isHeic = /\.heic$|\.heif$/i.test(file.name || '');
      let blob = file;

      if (isHeic) {
        try {
          blob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.9 });
        } catch (e) {
          console.warn('HEIC convert failed:', e);
        }
      }

      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
